<!DOCTYPE html>
<html>
  <head>
    <title>Place Searches</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAu1gWGp2bOSkaQfDLjgHVYD4CH20-Jn78&callback=initMap&libraries=places&v=weekly"
      defer
    ></script>
    <link rel="stylesheet" type="text/css" href="./style.css" />
  </head>
  <body>
    <p>
      latitude: <span id="latitude"></span>&deg;<br />
      longitude: <span id="longitude"></span>&deg;
    </p>
    <div>
      VALITUD KOHT: <span id="places"></span>
    </div>
    <button onclick="initMap()">Alusta</button>
    <div id="map"></div>

  <script>
let map, infoWindow, marker, bounds, currentInfoWindow;
let posit;
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(position => {
  posit = {
    lat: position.coords.latitude,
    lng: position.coords.longitude
  }
  document.getElementById('latitude').textContent = posit.lat;
  document.getElementById("longitude").textContent = posit.lng;
});
}



function initMap() {
  bounds = new google.maps.LatLngBounds();
  infoWindow = new google.maps.InfoWindow;
  currentInfoWindow = infoWindow;
  infoPane = document.getElementById('panel');
  map = new google.maps.Map(document.getElementById("map"), {
    center: posit,
    zoom: 13,
  });

  bounds.extend(posit);

  infoWindow.setPosition(posit);
          infoWindow.setContent('Location found.');
          infoWindow.open(map);
          map.setCenter(posit);

  
  getNearbyPlaces(posit);


  marker = new google.maps.Marker({
    map,
    draggable: true,
    animation: google.maps.Animation.DROP,
    position: posit,
    label: "Teie asukoht"
  });
}

function getNearbyPlaces(position) {
      let request = {
        location: position,
        rankBy: google.maps.places.RankBy.DISTANCE,
        keyword: 'park'
      };

      service = new google.maps.places.PlacesService(map);
      service.nearbySearch(request, nearbyCallback);
    }


    function nearbyCallback(results, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        createMarkers(results);
      }
    }

    function createMarkers(places) {
      places.splice(1, 19);
      places.forEach(place => {
        let marker = new google.maps.Marker({
          position: place.geometry.location,
          map: map,
          title: place.name
        });
document.getElementById("places").innerHTML=places;
        /* TODO: Step 4B: Add click listeners to the markers */
        // Add click listener to each marker
        google.maps.event.addListener(marker, 'click', () => {
          let request = {
            placeId: place.place_id,
            fields: ['name', 'formatted_address', 'geometry', 'rating',
              'website', 'photos']
          };

          /* Only fetch the details of a place when the user clicks on a marker.
           * If we fetch the details for all place results as soon as we get
           * the search response, we will hit API rate limits. */
          service.getDetails(request, (placeResult, status) => {
            showDetails(placeResult, marker, status)
          });
        });

        // Adjust the map bounds to include the location of this marker
        bounds.extend(place.geometry.location);
      });
      /* Once all the markers have been placed, adjust the bounds of the map to
       * show all the markers within the visible area. */
      map.fitBounds(bounds);
    }
  </script>
  </body>
</html>